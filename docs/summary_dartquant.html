<!DOCTYPE html>
<html>
<head>
<title>summary_dartquant.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="dartquant">DartQuant</h1>
<h2 id="preliminaries">Preliminaries</h2>
<p>LLM里的Linear layer可以表示为 $Y=XW^T$，其中 $X\in \mathbb{R}^{T\times C_\text{in}}$ 为输入激活，$W\in \mathbb{R}^{C_\text{out}\times C_\text{in}}$ 为权重矩阵。引入正交矩阵 $R\in \mathbb{R}^{C_\text{in}\times C_\text{in}}$（满足 $RR^\top=I$），可得等价变换：</p>
<p>$$Y=(XR)(R^\top W^\top)$$</p>
<h3 id="%E7%BB%8F%E5%85%B8transformer-block-llama">经典Transformer Block (LLaMA)</h3>
<p><img src="image/notes_darkquant/1769168502148.png" alt="经典结构"></p>
<h3 id="dartquant%E5%90%8E%E7%9A%84transformer-block-llama">DartQuant后的Transformer Block (LLaMA)</h3>
<p><img src="image/notes_darkquant/1769168547723.png" alt="DartQuant结构"></p>
<hr>
<h2 id="%E5%88%9B%E6%96%B0%E7%82%B9">创新点</h2>
<ol>
<li><strong>Rotational Distribution Calibration</strong>：提出高效的分布感知旋转校准方法，通过约束旋转后激活分布来降低优化复杂度</li>
<li><strong>Whip Loss</strong>：优化激活分布使其趋向均匀分布，减少outliers影响</li>
<li><strong>QR-Orth Optimization</strong>：用QR分解替代昂贵的流形优化（Cayley SGD），显著提升效率</li>
<li><strong>资源效率</strong>：首次在单张3090 GPU上完成70B模型的旋转校准（约3小时），实现47×加速和10×显存节省</li>
</ol>
<p><img src="image/notes_darkquant/1769166602593.png" alt="计算成本对比"></p>
<hr>
<h2 id="%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF">问题背景</h2>
<h3 id="%E6%BF%80%E6%B4%BBoutliers%E9%97%AE%E9%A2%98">激活Outliers问题</h3>
<p>LLM后训练量化中，激活值比权重更难处理，因为存在<strong>极端outliers</strong>会严重降低量化精度。</p>
<blockquote>
<p><em>Ma et al. (AffineQuant, ICLR 2024)</em>：旋转矩阵和仿射变换能有效减少激活outliers，显著提升量化性能。</p>
</blockquote>
<h3 id="%E5%BD%93%E5%89%8D%E6%97%8B%E8%BD%AC%E6%96%B9%E6%B3%95%E7%9A%84%E5%B1%80%E9%99%90">当前旋转方法的局限</h3>
<p><strong>旋转矩阵的优势</strong>：</p>
<ul>
<li>可逆、保范数（$|Rx|_2 = |x|_2$）</li>
<li>可无缝融入模型架构，不增加推理开销</li>
</ul>
<p><strong>现有方法问题</strong>：</p>
<ul>
<li>SpinQuant/OSTQuant将旋转矩阵作为网络参数进行端到端微调</li>
<li>需要Cayley SGD等流形优化器，计算开销约 $O(6n^3)$</li>
<li>小样本微调容易过拟合（见Table 1）</li>
<li>70B模型需数百GiB显存和数十GPU小时</li>
</ul>
<hr>
<h2 id="method">Method</h2>
<p><img src="image/notes_darkquant/1769170936353.png" alt="方法框架"></p>
<h3 id="41-rotational-distribution-calibration">4.1 Rotational Distribution Calibration</h3>
<p><strong>核心思想</strong>：不做端到端微调，而是直接优化旋转后激活的分布，使其更适合量化。</p>
<p><strong>优化目标</strong>：最小化outliers数量
$$\min_R\sum_{i=1}^{C_\text{in}}\mathbb{I}(|(Rx)_i|&gt;\tau)$$</p>
<p>其中 $\mathbb{I}(\cdot)$ 是指示函数，$\tau$ 是outlier阈值。</p>
<p><strong>为什么不用方差/峰度？</strong></p>
<ul>
<li><strong>方差不可行</strong>：由于激活对称分布，方差 $\propto |x|_2^2$。而旋转保范数，即 $|Rx|_2 = |x|_2$，导致方差在旋转前后不变，梯度信号极弱</li>
<li><strong>峰度收敛慢</strong>：旋转后激活已接近Gaussian，峰度优化速度慢（见Figure 7a）</li>
</ul>
<h3 id="42-whip-loss">4.2 Whip Loss</h3>
<p><strong>目标</strong>：将Laplace分布的激活转换为均匀分布，从而减少outliers。</p>
<p><img src="image/notes_darkquant/1769192918814.png" alt="分布变换直觉">
<img src="image/notes_darkquant/1769192959029.png" alt="Whip Loss效果"></p>
<p><strong>假设</strong>：激活服从 Laplace$(0, b)$ 分布，PDF为：
$$f(x) = \frac{1}{2b}\exp\left(-\frac{|x|}{b}\right)$$</p>
<p><strong>分布变换函数</strong>：用CDF将 $x \sim \text{Laplace}(0,b)$ 映射到均匀分布 $[-\tau, \tau]$：
$$U_X(x) = 2\tau\left[\int_{-\infty}^x \frac{1}{2b}\exp\left(-\frac{|t|}{b}\right)dt - \frac{1}{2}\right]
= \begin{cases}
\tau[\exp(\frac{x}{b})-1], &amp; x\le 0\
\tau[1-\exp(-\frac{x}{b})], &amp; x &gt; 0
\end{cases}$$</p>
<p><strong>Whip Loss设计</strong>：
$$\mathcal{L}<em>{\text{Whip}} = \sum</em>{i=1}^{C_\text{in}}\exp(-|x_i|)$$</p>
<p><strong>为什么Whip有效？</strong></p>
<ol>
<li>$\exp(-|x|)$ 在零点附近梯度大，将小值&quot;推离&quot;零点</li>
<li>由于旋转保范数（$|Rx|_2 = |x|_2$），中间值被放大时，outliers必须被压缩</li>
<li>最终效果：峰值被平滑，outliers被聚拢，分布趋向均匀</li>
</ol>
<blockquote>
<p><strong>直觉</strong>：4维向量 $[x_1, x_2, x_3, x_4]$，若 $x_1,x_2,x_3$ 小而 $x_4$ 是outlier。范数守恒下放大 $x_1,x_2,x_3$ 必然压缩 $x_4$。</p>
</blockquote>
<h3 id="43-qr-orth-optimization">4.3 QR-Orth Optimization</h3>
<p><strong>问题</strong>：直接梯度下降会破坏正交性
$$R' = R - \eta\frac{\partial \mathcal{L}}{\partial R} \quad \Rightarrow \quad R'R'^{\top} \neq I$$</p>
<p><strong>传统方案</strong>：Cayley SGD在Stiefel流形上优化，额外计算开销 $O(6n^3)$</p>
<p><strong>QR-Orth方案</strong>：引入无约束隐变量 $Z \in \mathbb{R}^{n\times n}$</p>
<p><strong>算法流程</strong>：</p>
<ol>
<li>初始化：$Z_0$ 为随机Hadamard矩阵</li>
<li>QR分解：$Z = RU$，取正交矩阵 $R$，丢弃上三角 $U$</li>
<li>前向传播：计算 $O = XR$，$\mathcal{L} = \text{Whip}(O)$</li>
<li>梯度更新：$Z \leftarrow Z - \eta \frac{\partial \mathcal{L}}{\partial Z}$</li>
<li>重复步骤2-4直到收敛</li>
</ol>
<p><strong>关键点</strong>：</p>
<ul>
<li>我们更新的是 $Z$（无约束），通过QR分解间接得到正交的 $R$</li>
<li>最终只保留 $R$，$Z$ 是辅助变量</li>
<li>QR分解复杂度 $O(\frac{4}{3}n^3)$，比Cayley SGD的 $O(6n^3)$ 额外开销低得多</li>
<li>实测加速 1.4×（相同迭代数），由于收敛更快，总体加速可达 41×</li>
</ul>
<h3 id="44-%E5%9B%9B%E4%B8%AA%E6%97%8B%E8%BD%AC%E7%9F%A9%E9%98%B5%E7%9A%84%E7%94%A8%E9%80%94">4.4 四个旋转矩阵的用途</h3>
<table>
<thead>
<tr>
<th>矩阵</th>
<th>位置</th>
<th>优化方式</th>
<th>推理开销</th>
</tr>
</thead>
<tbody>
<tr>
<td>$R_1$</td>
<td>层间（$W_q, W_k, W_v, W_{up}, W_{gate}$ 前）</td>
<td>DartQuant学习</td>
<td><strong>无</strong>（融入权重）</td>
</tr>
<tr>
<td>$R_2$</td>
<td>Attention内（$W_v$ 和 $W_o$ 之间）</td>
<td>DartQuant学习</td>
<td><strong>无</strong>（融入权重）</td>
</tr>
<tr>
<td>$R_3$</td>
<td>RoPE后的Q、K之间</td>
<td>随机Hadamard</td>
<td>有（online计算，用fast kernel）</td>
</tr>
<tr>
<td>$R_4$</td>
<td>$W_{down}$ 前</td>
<td>随机Hadamard</td>
<td>有（online计算，用fast kernel）</td>
</tr>
</tbody>
</table>
<h3 id="45-%E5%90%8E%E7%BB%AD%E9%87%8F%E5%8C%96%E6%B5%81%E7%A8%8B">4.5 后续量化流程</h3>
<p>旋转校准完成后：</p>
<ol>
<li>将 $R_1, R_2$ 融入相邻权重矩阵</li>
<li>使用 <strong>GPTQ</strong> 对权重进行重建（128样本，序列长度2048）</li>
<li>激活使用 per-token 非对称量化</li>
</ol>
<hr>
<h2 id="%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C">实验结果</h2>
<h3 id="%E4%B8%BB%E8%A6%81%E7%BB%93%E6%9E%9Cw4a4kv16">主要结果（W4A4KV16）</h3>
<table>
<thead>
<tr>
<th>模型</th>
<th>方法</th>
<th>PPL ↓</th>
<th>0-shot Acc ↑</th>
</tr>
</thead>
<tbody>
<tr>
<td>LLaMA-2 70B</td>
<td>SpinQuant</td>
<td>11.70</td>
<td>68.59</td>
</tr>
<tr>
<td>LLaMA-2 70B</td>
<td>OSTQuant</td>
<td>11.98</td>
<td>68.29</td>
</tr>
<tr>
<td>LLaMA-2 70B</td>
<td><strong>DartQuant</strong></td>
<td><strong>11.51</strong></td>
<td><strong>69.02</strong></td>
</tr>
<tr>
<td>LLaMA-3 70B</td>
<td>SpinQuant</td>
<td>9.61</td>
<td>66.06</td>
</tr>
<tr>
<td>LLaMA-3 70B</td>
<td>OSTQuant</td>
<td>7.67</td>
<td>67.94</td>
</tr>
<tr>
<td>LLaMA-3 70B</td>
<td><strong>DartQuant</strong></td>
<td>7.99</td>
<td><strong>69.39</strong></td>
</tr>
</tbody>
</table>
<h3 id="%E8%B5%84%E6%BA%90%E6%B6%88%E8%80%97%E5%AF%B9%E6%AF%9470b%E6%A8%A1%E5%9E%8B">资源消耗对比（70B模型）</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>时间 (GPU hour)</th>
<th>显存 (GiB)</th>
</tr>
</thead>
<tbody>
<tr>
<td>SpinQuant</td>
<td>42.90</td>
<td>238.89</td>
</tr>
<tr>
<td>OSTQuant</td>
<td>44.00</td>
<td>583.86</td>
</tr>
<tr>
<td><strong>DartQuant</strong></td>
<td><strong>0.91</strong></td>
<td><strong>23.47</strong></td>
</tr>
<tr>
<td>DartQuant (3090)</td>
<td>2.90</td>
<td>23.47</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="appendix-%E8%A6%81%E7%82%B9">Appendix 要点</h2>
<h3 id="a-laplace%E5%81%87%E8%AE%BE%E7%9A%84%E9%AA%8C%E8%AF%81">A. Laplace假设的验证</h3>
<p>Table 19显示LLaMA系列激活统计特性：</p>
<ul>
<li>Mean ≈ $10^{-2}$ 量级（接近0）</li>
<li>Variance ≈ 1</li>
<li>Kurtosis &gt;&gt; 0（重尾特性，Gaussian的kurtosis=0）</li>
</ul>
<p><strong>局限</strong>：若mean显著偏离0，Whip Loss效果可能下降。</p>
<p><img src="image/notes_darkquant/1769194688478.png" alt="激活统计">
<img src="image/notes_darkquant/1769194672006.png" alt="激活分布"></p>
<h3 id="b-%E5%A4%8D%E6%9D%82%E5%BA%A6%E5%88%86%E6%9E%90">B. 复杂度分析</h3>
<ul>
<li>QR分解（Householder）：$\frac{4}{3}n^3$</li>
<li>Cayley SGD额外开销：$6n^3$</li>
<li>加速比：$\approx 1.4\times$（单次迭代），$\approx 41\times$（考虑收敛速度）</li>
</ul>
<h3 id="c-%E6%8A%97%E8%BF%87%E6%8B%9F%E5%90%88%E9%AA%8C%E8%AF%81">C. 抗过拟合验证</h3>
<p>Table 1显示端到端微调在特定数据集上过拟合明显（PTB上PPL下降但泛化变差）。DartQuant对校准数据集不敏感（Table 5）。</p>
<hr>
<h2 id="%E6%80%BB%E7%BB%93">总结</h2>
<p><strong>核心贡献</strong>：</p>
<ol>
<li>用分布校准替代端到端微调，避免过拟合</li>
<li>Whip Loss利用旋转保范数特性，通过放大小值来压缩outliers</li>
<li>QR-Orth将流形优化转化为无约束优化，大幅降低计算开销</li>
<li>首次实现单张消费级GPU量化70B模型</li>
</ol>

</body>
</html>
